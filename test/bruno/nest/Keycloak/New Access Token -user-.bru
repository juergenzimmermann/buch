meta {
  name: New Access Token "user"
  type: http
  seq: 4
}

post {
  url: {{keycloak_url}}/realms/nest/protocol/openid-connect/token
  body: formUrlEncoded
  auth: basic
}

auth:basic {
  username: {{client_id}}
  password: {{client_secret}}
}

body:form-urlencoded {
  grant_type: password
  username: user
  password: p
}

script:post-response {
  test('Statuscode 200', () => {
      expect(res.getStatus()).to.equal(200);
  });
  test('Content-Type application/json', () => {
      const contentType = res.getHeader('Content-Type');
      expect(contentType).to.match(/^application\/json(; charset=utf-8)?/u);
  });
  test('Body mit token, expiresIn, roles', () => {
      const body = res.getBody();
      console.log(`${JSON.stringify(body)}`);
      const { access_token, expires_in, refresh_token, refresh_expires_in } = body;
      expect(access_token).to.be.a('string').that.matches(/.+\..+\..+/u);
      expect(expires_in).to.be.equal(1800);
      expect(refresh_token).to.be.a('string').that.matches(/.+\..+\..+/u);
      expect(refresh_expires_in).to.be.equal(3600);
  });
}

settings {
  encodeUrl: true
}
